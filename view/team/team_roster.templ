package view

import "ultigamecast/modelspb"
import "github.com/labstack/echo/v5"
import "ultigamecast/view/util"
import "strconv"
import "fmt"
import "ultigamecast/view/icon"
import "ultigamecast/view/component"

templ TeamRoster(e echo.Context, teamSlug string) {
	<div role="tablist" class="tabs tabs-bordered" aria-controls="tab-content">
		<button hx-get={ util.JoinSlugsString("/team", teamSlug, "tournaments") } role="tab" aria-controls="tab-content" aria-selected="false" class="tab">Tournaments</button>
		<button hx-get={ util.JoinSlugsString("/team", teamSlug, "roster") } role="tab" aria-controls="tab-content" aria-selected="false" class="tab tab-active">Roster</button>
	</div>
	<div
		id="roster_table"
		hx-get={ util.JoinSlugsString("/team", teamSlug, "rosterTable") }
		hx-trigger="load"
		hx-target="this"
		hx-swap="outerHTML"
		class="flex flex-col gap-2 items-center text-primary pt-8"
	>
		@icon.LoadingLg()
		<span>Loading stats...</span>
	</div>
	<dialog class="modal" id="player_modal" hx-on::afterSwap="this.showModal()" hx-on:formsuccess="setTimeout(() => this.close())">
		<div id="player_modal_content"></div>
		<form method="dialog" class="modal-backdrop"><button>close</button></form>
	</dialog>
}

type PlayerData struct {
	TeamSlug   string
	PlayerID   string
	PlayerName string
}

templ PlayerDialogContent(c echo.Context, title string, data PlayerData) {
	<div id="player_modal_content">
		<h3 class="font-bold text-lg">{ title }</h3>
		<form
			if data.PlayerID == "" {
				hx-post={ util.JoinSlugsString("/team", data.TeamSlug, "roster") }
			} else {
				hx-put={ util.JoinSlugsString("/team", data.TeamSlug, "roster", data.PlayerID) }
			}
			hx-boost="true"
			hx-disabled-elt="#player_modal_submit"
		>
			@component.InputWrapperLabel(c, "name", "player_name", "Name") {
				<input
					type="text"
					id="player_name"
					class="input input-bordered"
					placeholder="Name"
					value={ data.PlayerName }
				/>
			}
		</form>
		<div class="modal-body">
			<div class="modal-action">
				<form method="dialog"><button type="button" class="btn">Close</button></form>
				<button id="player_modal_submit" form="player_modal_form" class="btn btn-primary">Submit</button>
			</div>
		</div>
	</div>
}

templ RosterTable(teamSlug string, summaryType string, players []modelspb.PlayerSummary, orderByField string, orderByAsc bool) {
	<div id="roster_table" class="overflow-x-auto">
		<table class="table table-zebra table-pin-rows">
			<thead>
				<tr>
					@rosterTableColumnnHeader(teamSlug, "Name", "player_name", orderByField == "player_name", orderByAsc)
					@rosterTableColumnnHeader(teamSlug, "Points", "points", orderByField == "points", orderByAsc)
					@rosterTableColumnnHeader(teamSlug, "Goals", "goals", orderByField == "goals", orderByAsc)
					@rosterTableColumnnHeader(teamSlug, "Assists", "assists", orderByField == "assists", orderByAsc)
					@rosterTableColumnnHeader(teamSlug, "Turns", "turns", orderByField == "turns", orderByAsc)
					@rosterTableColumnnHeader(teamSlug, "Drops", "drops", orderByField == "drops", orderByAsc)
					<th></th>
				</tr>
			</thead>
			<tbody>
				for _, player := range players {
					@PlayerSummaryRow(summaryType, player)
				}
			</tbody>
		</table>
	</div>
}

templ PlayerSummaryRow(summaryType string, player modelspb.PlayerSummary) {
	<tr
		id={ fmt.Sprintf("player_%s", player.GetPlayerId()) }
	>
		<td>
			<div class="flex items-center gap-1">
				if summaryType == "team" {
					<button></button>
				}
				{ player.GetPlayerName() }
			</div>
		</td>
		<td>{ strconv.Itoa(player.GetPoints()) }</td>
		<td>{ strconv.Itoa(player.GetGoals()) }</td>
		<td>{ strconv.Itoa(player.GetAssists()) }</td>
		<td>{ strconv.Itoa(player.GetTurns()) }</td>
		<td>{ strconv.Itoa(player.GetDrops()) }</td>
	</tr>
}

templ rosterTableColumnnHeader(teamSlug string, title string, field string, isOrderedBy bool, orderByAsc bool) {
	<th
		if isOrderedBy && orderByAsc {
			hx-get={ util.JoinSlugsString("/team", teamSlug, "rosterTable") + fmt.Sprintf("?orderby=%s&dir=desc", field) }
		}
		if isOrderedBy && !orderByAsc {
			hx-get={ util.JoinSlugsString("/team", teamSlug, "rosterTable") }
		}
		if !isOrderedBy {
			hx-get={ util.JoinSlugsString("/team", teamSlug, "rosterTable") + fmt.Sprintf("?orderby=%s&dir=asc", field) }
		}
		hx-target="#roster_table"
		hx-swap="outerHTML"
		role="button"
		class="cursor-pointer"
	>
		<div class="flex items-center gap-1">
			{ title }
			if isOrderedBy && orderByAsc {
				@icon.ChevronUp()
			}
			if isOrderedBy && !orderByAsc {
				@icon.ChevronDown()
			}
		</div>
	</th>
}
